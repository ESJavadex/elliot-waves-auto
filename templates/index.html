<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elliott Wave Analysis & Trade Ideas (2025-04-21)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Base Variables */
        :root {
            --bg-primary: #1a1d24;
            --bg-secondary: #252a33;
            --bg-tertiary: #2d3340;
            --bg-input: #343c4a;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --text-muted: #8a8d91;
            --accent-primary: #4d84ff; /* Brighter Blue */
            --accent-secondary: #3a6bc5; /* Medium Blue */
            --accent-tertiary: #2e4e8f; /* Darker Blue */
            --success: #4ade80; /* Green */
            --warning: #facc15; /* Yellow */
            --danger: #f87171; /* Red */
            --border-color: #3e4756; /* Darker Grey Border */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.15), 0 1px 2px rgba(0,0,0,0.25);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.2), 0 3px 6px rgba(0,0,0,0.25);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.25), 0 6px 10px rgba(0,0,0,0.25);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition-fast: all 0.2s ease;
            --transition-normal: all 0.3s ease;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        /* Base Styles */
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; margin: 0; padding: 0; min-height: 100vh; }
        .container { background-color: var(--bg-secondary); padding: 40px; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); max-width: 1500px; margin: 30px auto; border: 1px solid var(--border-color); }

        /* Headings */
        h1, h2, h3 { text-align: center; color: var(--accent-primary); margin-bottom: 30px; font-weight: 600; letter-spacing: -0.02em; }
        h1 { font-size: 2.4em; margin-top: 0; background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-tertiary) 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; position: relative; display: inline-block; left: 50%; transform: translateX(-50%); padding-bottom: 15px; }
        h1::after { content: ''; position: absolute; bottom: 0; left: 10%; right: 10%; height: 3px; background: linear-gradient(90deg, transparent, var(--accent-primary), transparent); border-radius: 3px; }
        h2 { font-size: 1.8em; margin-top: 50px; position: relative; padding-bottom: 15px; }
        h2::after { content: ''; position: absolute; bottom: 0; left: 30%; right: 30%; height: 2px; background: linear-gradient(90deg, transparent, var(--accent-secondary), transparent); border-radius: 2px; }
        h3 { font-size: 1.4em; color: var(--accent-secondary); margin-bottom: 25px; }
        /* Section Sub-Title (e.g., for Backtest/Risk) */
        h4 { font-size: 1.15em; color: var(--text-primary); margin-bottom: 20px; text-align: center; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); width: 100%; font-weight: 500; }

        /* Form General */
        form { display: flex; flex-direction: column; gap: 0; /* No gap between sections, handled inside */ margin-bottom: 50px; padding: 0; /* Remove padding from form itself */ background-color: transparent; border: none; box-shadow: none; position: relative; }
        form::before { content: none; /* Remove top gradient line from form */ }

        /* --- Condensed Form Section (The *Single* Main Box) --- */
        .condensed-form-section {
            display: flex;
            flex-direction: column;
            gap: 30px; /* Gap between main grid, backtest, risk, submit groups */
            padding: 30px; /* Padding for the entire box */
            background-color: var(--bg-tertiary); /* Background for the box */
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            position: relative; /* For pseudo elements if needed */
             overflow: hidden;
        }
        /* Optional Top Accent Line for the Condensed Box */
         .condensed-form-section::before {
             content: '';
             position: absolute;
             top: 0; left: 0; right: 0;
             height: 4px;
             background: linear-gradient(90deg, var(--accent-tertiary), var(--accent-primary), var(--accent-tertiary));
             z-index: 1;
         }

        /* Grid for Main Settings (Mode, Ticker/List, Dates, Interval) */
        .main-settings-grid {
            display: grid;
            /* Adjust columns based on desired layout - 3 columns seems feasible */
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px 25px; /* Row gap, Column gap */
            width: 100%;
        }

        /* Grid Item Placement (Example - adjust as needed) */
        .mode-select-group {
            /* grid-column: span 3; Or place in a specific column */
             grid-column: 1 / -1; /* Span full width */
             max-width: 400px; /* Limit width */
             justify-self: center; /* Center within the span */
        }
        #single-ticker-group {
             grid-column: span 2; /* Example: Ticker takes 2 columns */
        }
        #multi-stock-inputs {
             grid-column: span 2; /* Example: Multi-stock takes 2 columns */
             display: flex; /* Controlled by JS */
             flex-direction: column;
             gap: 15px;
        }
        .quick-presets-container { /* Wrap presets if needed */
             grid-column: span 1; /* Example: Presets take 1 column */
             display: flex;
             flex-direction: column;
             gap: 5px;
             align-items: flex-start;
             margin-top: 18px; /* Align roughly with Ticker label */
        }
         .quick-presets { display: flex; flex-wrap: wrap; gap: 10px; }
         .quick-presets-label { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px; width: 100%; text-align: left; }

        /* Input Group Styling within the Grid */
        .main-settings-grid .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px; /* Smaller gap within input group */
        }
        .main-settings-grid label {
            font-size: 0.9em;
            margin-bottom: 0; /* Remove bottom margin */
            justify-content: flex-start;
        }
        .main-settings-grid small {
            font-size: 0.8em;
            margin-top: 2px; /* Tighter helper text */
            text-align: left;
        }

        /* Backtest & Risk Groups (Inside the main section) */
        .backtest-group, .risk-group {
            border-top: 1px solid var(--border-color);
            padding-top: 25px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
         .backtest-group h4, .risk-group h4 {
             margin-bottom: 15px; /* Less margin below title */
             border-bottom: none; /* Remove duplicate border */
             padding-bottom: 0;
             font-size: 1.1em; /* Slightly smaller title */
         }
        .backtest-dates, .risk-inputs-row {
             display: flex;
             flex-wrap: wrap;
             gap: 20px;
             justify-content: center;
             width: 100%;
        }
        .backtest-dates .input-group, .risk-inputs-row .input-group {
             flex-grow: 1;
             min-width: 200px;
             max-width: 300px;
         }
         .backtest-info {
             max-width: 650px; /* Limit info width */
             margin-top: 15px;
         }
         .backtest-group small, .risk-group small {
             font-size: 0.8em; color: var(--text-muted); display: block;
             margin-top: 4px; text-align: left;
         }

        /* Submit Group (Inside the main section) */
        .submit-group {
            border-top: 1px solid var(--border-color);
            padding-top: 25px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* General Input Styling */
        label { margin-bottom: 8px; font-weight: 500; color: var(--text-primary); font-size: 0.95em; display: flex; align-items: center; gap: 8px; }
        input[type="text"], input[type="date"], select, input[type="number"] { padding: 12px 15px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background-color: var(--bg-input); color: var(--text-primary); font-size: 1em; width: 100%; transition: var(--transition-fast); box-shadow: inset 0 1px 3px rgba(0,0,0,0.15); outline: none; }
        input:focus, select:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(77, 132, 255, 0.25), inset 0 1px 3px rgba(0,0,0,0.15); }
        input::placeholder { color: var(--text-muted); }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8) brightness(1.1); cursor: pointer; transition: var(--transition-fast); }
        input[type="date"]::-webkit-calendar-picker-indicator:hover { filter: invert(1) brightness(1); }
        select { cursor: pointer; appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="%23e4e6eb" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); background-repeat: no-repeat; background-position: right 15px center; background-size: 1.2em; padding-right: 40px; }
        input[type="submit"] { padding: 14px 40px; background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; transition: var(--transition-normal); font-weight: 600; font-size: 1.05em; width: auto; box-shadow: var(--shadow-md); position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 0.8px; }
        input[type="submit"]::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: var(--transition-normal); }
        input[type="submit"]:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.35); }
        input[type="submit"]:hover::before { left: 100%; }
        input[type="submit"]:active { transform: translateY(0px); box-shadow: 0 3px 6px rgba(0,0,0,0.2); }

        /* Toggle Switch Styles */
        .form-toggle { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .toggle-switch { position: relative; display: inline-flex; align-items: center; cursor: pointer; user-select: none; vertical-align: middle; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-slider { position: relative; display: inline-block; width: 44px; height: 24px; background-color: var(--bg-input); border-radius: 24px; transition: var(--transition-normal); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); border: 1px solid var(--border-color); }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: var(--text-secondary); border-radius: 50%; transition: var(--transition-normal); box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input:checked + .toggle-slider { background-color: var(--accent-primary); border-color: var(--accent-secondary); }
        input:checked + .toggle-slider:before { transform: translateX(20px); background-color: white; }
        .toggle-label { color: var(--text-secondary); font-size: 0.95em; font-weight: 500; cursor: pointer; transition: color var(--transition-fast); }
        .toggle-label:hover { color: var(--text-primary); }

        /* --- Results Area Styling --- */
        /* (Keeping these styles largely the same as previous full code for brevity) */
        .plot-container { margin-top: 40px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background-color: rgba(0, 0, 0, 0.2); padding: 15px; overflow-x: auto; box-shadow: var(--shadow-md); transition: var(--transition-normal); position: relative; }
        .plot-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, transparent, var(--accent-primary), transparent); border-radius: 3px 3px 0 0; }
        .plot-container:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
        .plot-container .plotly-graph-div { width: 100% !important; }
        .error { color: var(--danger); text-align: center; font-weight: 600; margin: 30px 0; padding: 18px; background-color: rgba(248, 113, 113, 0.1); border: 1px solid var(--danger); border-radius: var(--radius-md); box-shadow: var(--shadow-sm); position: relative; }
        .error::before { content: '⚠️'; display: inline-block; margin-right: 10px; font-size: 1.2em; }
        .disclaimer { margin-top: 60px; padding: 25px; border: 1px solid var(--warning); background-color: rgba(250, 204, 21, 0.05); color: var(--warning); border-radius: var(--radius-md); text-align: center; font-size: 0.95em; line-height: 1.6; box-shadow: var(--shadow-sm); position: relative; }
        .disclaimer::before { content: ''; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 70%; height: 2px; background: linear-gradient(90deg, transparent, var(--warning), transparent); }
        .disclaimer strong { font-weight: 700; color: var(--warning); display: block; margin-bottom: 10px; font-size: 1.1em; }
        pre { background-color: var(--bg-primary); padding: 20px; border-radius: var(--radius-md); border: 1px solid var(--border-color); white-space: pre-wrap; word-wrap: break-word; color: var(--text-secondary); font-size: 0.9em; max-height: 450px; overflow-y: auto; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); font-family: 'Fira Code', 'Consolas', monospace; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; margin-top: 40px; }
        .summary-section { background-color: var(--bg-tertiary); padding: 25px 30px; border-radius: var(--radius-md); border: 1px solid var(--border-color); box-shadow: var(--shadow-md); transition: var(--transition-normal); position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .summary-section::before { content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: linear-gradient(to bottom, var(--accent-primary), var(--accent-tertiary)); }
        .summary-section:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .summary-section h3 { color: var(--success); margin-top: 0; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); font-size: 1.25em; position: relative; text-align: left; width: 100%; }
        .summary-section h3::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 60px; height: 3px; background-color: var(--success); border-radius: 3px; }
        .summary-section.correction-guess h3 { color: #ff69b4; }
        .summary-section.correction-guess h3::after { background-color: #ff69b4; }
        .summary-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .summary-list li { margin-bottom: 12px; color: var(--text-secondary); font-size: 0.95em; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; padding-bottom: 10px; border-bottom: 1px dotted var(--border-color); transition: var(--transition-fast); line-height: 1.4; }
        .summary-list li:hover { background-color: rgba(255, 255, 255, 0.02); transform: translateX(4px); border-bottom-color: var(--accent-primary); }
        .summary-list li:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .summary-list .value, .summary-list span[class^="value-"] { font-weight: 600; color: var(--accent-primary); margin-left: 10px; text-align: right; flex-shrink: 0; }
        .summary-list .value-true { color: var(--success); position: relative; }
        .summary-list .value-true::before { content: '✓'; margin-right: 4px; font-size: 0.9em; font-weight: bold; }
        .summary-list .value-false { color: var(--danger); position: relative; }
        .summary-list .value-false::before { content: '✗'; margin-right: 4px; font-size: 0.9em; font-weight: bold; }
        .summary-list.checks li { font-size: 0.9em; }
        .summary-list.fibs .value { color: #c678dd; }
        .summary-list.fibs span.value + span { color: #abb2bf; font-weight: normal; font-size: 0.9em; margin-left: 5px; }
        details { margin-top: 25px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background-color: var(--bg-secondary); box-shadow: var(--shadow-sm); transition: var(--transition-fast); overflow: hidden; }
        details:hover { box-shadow: var(--shadow-md); border-color: var(--accent-secondary); }
        summary { padding: 14px 18px; font-weight: 600; cursor: pointer; color: var(--warning); background-color: var(--bg-tertiary); outline: none; transition: var(--transition-fast); position: relative; list-style: none; display: block; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: '►'; color: var(--warning); margin-right: 12px; display: inline-block; transition: transform 0.3s ease-in-out; font-size: 0.8em; }
        details[open] summary::before { transform: rotate(90deg); }
        summary:hover { background-color: rgba(255, 255, 255, 0.05); color: var(--accent-primary); }
        summary:hover::before { color: var(--accent-primary); }
        details[open] summary { border-bottom: 1px solid var(--border-color); }
        details > *:not(summary) { padding: 20px; }
        details pre { margin-top: 0; max-height: 350px; font-size: 0.85em; }
        ul.raw-vol { font-size: 0.9em; list-style: none; padding: 0; margin: 0;}
        ul.raw-vol li { border-bottom: none; margin-bottom: 5px; }
        ul.raw-vol .value { color: #abb2bf; font-weight: normal; }
        .correction-guess { background: linear-gradient(135deg, rgba(255, 105, 180, 0.07) 0%, rgba(255, 105, 180, 0.03) 100%); border-color: rgba(255, 105, 180, 0.4); }
        .correction-guess::before { background: linear-gradient(to bottom, #ff69b4, #e05c9f); }
        .trade-recommendation-section { background-color: var(--bg-tertiary); padding: 30px 35px; border-radius: var(--radius-md); border: 1px solid var(--border-color); margin-top: 50px; box-shadow: var(--shadow-md); transition: var(--transition-normal); position: relative; overflow: hidden; }
        .trade-recommendation-section::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--accent-tertiary), var(--accent-primary), var(--accent-tertiary)); }
        .trade-recommendation-section::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at top right, rgba(77, 132, 255, 0.08), transparent 70%); pointer-events: none; opacity: 0.7; }
        .trade-recommendation-section:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .trade-recommendation-section h3 { color: var(--accent-primary); margin-top: 0; margin-bottom: 30px; padding-bottom: 18px; border-bottom: 1px solid var(--border-color); font-size: 1.4em; text-align: center; position: relative; }
        .trade-recommendation-section h3::after { content: ''; position: absolute; bottom: -1px; left: 35%; right: 35%; height: 3px; background: var(--accent-primary); border-radius: 3px; }
        .trade-recommendation-section .trade-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 25px 35px; margin-bottom: 30px; }
        .trade-recommendation-section .trade-item { background-color: rgba(0, 0, 0, 0.2); padding: 18px 22px; border-radius: var(--radius-sm); border-left: 5px solid transparent; box-shadow: var(--shadow-sm); transition: var(--transition-fast); position: relative; }
        .trade-recommendation-section .trade-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); background-color: rgba(0, 0, 0, 0.25); }
        .trade-recommendation-section .trade-item label { font-weight: 500; color: var(--text-secondary); display: block; font-size: 0.88em; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.6px; }
        .trade-recommendation-section .trade-item .value { font-weight: 600; font-size: 1.2em; color: var(--text-primary); text-shadow: 0 1px 2px rgba(0,0,0,0.2); line-height: 1.3; }
        .trade-recommendation-section .signal-long { border-left-color: var(--success); background: linear-gradient(to right, rgba(74, 222, 128, 0.08), transparent 80%); }
        .trade-recommendation-section .signal-short { border-left-color: var(--danger); background: linear-gradient(to right, rgba(248, 113, 113, 0.08), transparent 80%); }
        .trade-recommendation-section .signal-long .value { color: var(--success); }
        .trade-recommendation-section .signal-short .value { color: var(--danger); }
        .trade-recommendation-section .confidence-score .value { color: var(--warning); }
        .trade-recommendation-section .risk-reward .value { color: #c678dd; }
        .trade-recommendation-section .no-trade { color: var(--text-muted); text-align: center; font-style: italic; padding: 25px; background-color: rgba(0, 0, 0, 0.15); border-radius: var(--radius-sm); border: 1px dashed var(--border-color); font-size: 1.05em; }
        .trade-recommendation-section .trade-notes { font-size: 0.95em; color: var(--text-secondary); margin-top: 25px; text-align: center; border-top: 1px dotted var(--border-color); padding-top: 20px; line-height: 1.6; }
        .trade-recommendation-section .trade-item small { color: var(--text-muted); display: block; font-size: 0.85em; margin-top: 4px; line-height: 1.3; }
        .multi-stock-results { margin: 30px 0; overflow-x: auto; transition: var(--transition-normal); border-radius: var(--radius-md); box-shadow: var(--shadow-md); opacity: 1; max-height: 1000px; }
        .multi-stock-results.collapsed { max-height: 0; overflow: hidden; opacity: 0; margin-top: 0; margin-bottom: 0; box-shadow: none; border: none; }
        .stock-results-table { width: 100%; border-collapse: separate; border-spacing: 0; background-color: var(--bg-tertiary); border-radius: var(--radius-md); overflow: hidden; box-shadow: var(--shadow-md); }
        .stock-results-table th, .stock-results-table td { padding: 16px 20px; text-align: left; border-bottom: 1px solid var(--border-color); transition: var(--transition-fast); white-space: nowrap; }
        .stock-results-table th { background-color: var(--bg-secondary); color: var(--accent-primary); font-weight: 600; text-transform: uppercase; font-size: 0.88em; letter-spacing: 0.6px; position: sticky; top: 0; z-index: 10; }
        .stock-results-table tr:last-child td { border-bottom: none; }
        .stock-results-table tr:nth-child(even) td { background-color: rgba(0,0,0,0.1); }
        .stock-results-table tr.trade-found { position: relative; }
        .stock-results-table tr.trade-found td:first-child { position: relative; font-weight: 600; }
        .stock-results-table tr.trade-found td:first-child::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background-color: var(--accent-primary); }
        .stock-results-table tr.no-trade { color: var(--text-muted); opacity: 0.8; }
        .stock-results-table tr:not(.no-trade):hover { background-color: rgba(77, 132, 255, 0.1); }
        .stock-results-table tr.no-trade:hover { background-color: rgba(255, 255, 255, 0.04); opacity: 1; }
        .show-plot-form { margin: 0; padding: 0; display: flex; justify-content: center; }
        .show-plot-btn { padding: 8px 16px; background-color: var(--accent-secondary); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.85em; font-weight: 500; transition: var(--transition-fast); box-shadow: var(--shadow-sm); text-transform: uppercase; letter-spacing: 0.5px; }
        .show-plot-btn:hover { background-color: var(--accent-primary); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .show-plot-btn:active { transform: translateY(0); box-shadow: var(--shadow-sm); background-color: var(--accent-tertiary); }
        .filter-controls { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; padding: 18px 25px; background-color: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-color); }
        .stocks-count { color: var(--text-secondary); font-size: 0.9em; background-color: rgba(0, 0, 0, 0.2); padding: 8px 14px; border-radius: var(--radius-sm); border: 1px solid var(--border-color); }
        .table-controls { display: flex; align-items: center; gap: 18px; }
        .toggle-table-btn { display: flex; align-items: center; gap: 10px; padding: 9px 18px; background-color: var(--bg-tertiary); color: var(--accent-primary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer; font-size: 0.9em; transition: var(--transition-fast); font-weight: 500; }
        .toggle-table-btn:hover { background-color: var(--bg-input); border-color: var(--accent-primary); transform: translateY(-1px); }
        .toggle-table-btn .icon { transition: transform 0.3s ease; font-size: 1.1em; line-height: 1; width: 1em; text-align: center; }
        .toggle-table-btn.collapsed .icon { transform: rotate(-90deg); }
        .preset-btn { padding: 9px 16px; background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); cursor: pointer; font-size: 0.88em; transition: var(--transition-fast); box-shadow: var(--shadow-sm); font-weight: 500; }
        .preset-btn:hover { background-color: var(--bg-input); border-color: var(--accent-primary); color: var(--accent-primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .preset-btn:active { transform: translateY(0); box-shadow: var(--shadow-sm); }
        tr.no-trade.hidden { display: none; }
        th.sortable { cursor: pointer; position: relative; user-select: none; padding-right: 30px; }
        th.sortable::after { content: ''; position: absolute; right: 10px; top: 50%; transform: translateY(calc(-50% + 2px)); border: 4px solid transparent; border-top-color: var(--text-muted); opacity: 0.5; transition: opacity var(--transition-fast), border-color var(--transition-fast); width: 0; height: 0; border-bottom-width: 0; }
        th.sortable::before { content: ''; position: absolute; right: 10px; top: 50%; transform: translateY(calc(-50% - 2px)); border: 4px solid transparent; border-bottom-color: var(--text-muted); opacity: 0.5; transition: opacity var(--transition-fast), border-color var(--transition-fast); width: 0; height: 0; border-top-width: 0; }
        th.sortable:hover::after, th.sortable:hover::before { opacity: 0.8; }
        th.sort-asc::after { opacity: 0.3; }
        th.sort-asc::before { opacity: 1; border-bottom-color: var(--accent-primary); }
        th.sort-desc::before { opacity: 0.3; }
        th.sort-desc::after { opacity: 1; border-top-color: var(--accent-primary); }
        .wave-cell { position: relative; text-align: center; }
        .wave-label { font-weight: bold; font-size: 1.1em; margin-right: 5px; color: var(--text-primary); }
        .correction-badge { display: inline-block; font-size: 0.75em; padding: 3px 6px; background-color: rgba(255, 105, 180, 0.8); color: white; border-radius: var(--radius-sm); margin-left: 5px; cursor: help; vertical-align: middle; font-weight: 500; }
        .impulse-badge { display: inline-block; font-size: 0.8em; padding: 2px 5px; background-color: rgba(77, 132, 255, 0.8); color: white; border-radius: 50%; margin-left: 5px; cursor: help; vertical-align: middle; font-weight: bold; line-height: 1; }
        footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; font-size: 0.9em; color: var(--text-muted); }
        footer a { color: var(--text-secondary); text-decoration: none; transition: color var(--transition-fast); }
        footer a:hover { color: var(--accent-primary); text-decoration: underline; }

    </style>
</head>
<body>
    <div class="container">
        <h1>Conceptual Elliott Wave Analysis & Trade Ideas</h1>

        <form method="POST">
            <div class="condensed-form-section">

                <div class="main-settings-grid">
                    <div class="input-group mode-select-group">
                        <label for="analysis_mode">Analysis Mode</label>
                        <select id="analysis_mode" name="analysis_mode">
                            <option value="single" {% if form_values.analysis_mode != 'multi' %}selected{% endif %}>Single Stock</option>
                            <option value="multi" {% if form_values.analysis_mode == 'multi' %}selected{% endif %}>Multiple Stocks</option>
                        </select>
                    </div>

                    <div class="input-group" id="single-ticker-group" style="/* grid-column: span 2; */">
                        <label for="ticker">Ticker:</label>
                        <input type="text" id="ticker" name="ticker" value="{{ form_values.ticker | default('^SPX', true) }}">
                        <small>Enter a single stock ticker (e.g., AAPL, ^SPX).</small>
                    </div>

                    <div id="multi-stock-inputs" style="/* grid-column: span 2; */">
                        <div class="input-group">
                            <label for="stock_list">Stock List (comma separated):</label>
                            <input type="text" id="stock_list" name="stock_list" value="{{ form_values.stock_list }}" placeholder="MSFT,AAPL,NVDA,SPY">
                            <small>Enter multiple tickers separated by commas.</small>
                        </div>
                         <div class="quick-presets-container"> <span class="quick-presets-label">Quick Presets:</span>
                            <div class="quick-presets">
                                <button type="button" class="preset-btn" data-stocks="MSFT,AAPL,NVDA,GOOGL,META,AMZN,TSLA">Tech Giants</button>
                                <button type="button" class="preset-btn" data-stocks="SPY,QQQ,DIA,IWM,VTI">Major ETFs</button>
                                <button type="button" class="preset-btn" onclick="alert('Preset too large. Please paste a list manually.');">Large Cap Example (Manual)</button>
                                <button type="button" class="preset-btn" data-stocks="">Clear</button>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="start_date">Start Date:</label>
                        <input type="date" id="start_date" name="start_date" value="{{ form_values.start_date | default(default_start_date, true) }}" required>
                    </div>
                    <div class="input-group">
                        <label for="end_date">End Date (Standard):</label>
                        <input type="date" id="end_date" name="end_date" value="{{ form_values.end_date | default(default_end_date, true) }}">
                        <small>Leave blank for today.</small>
                    </div>
                    <div class="input-group">
                        <label for="interval">Interval:</label>
                        <select id="interval" name="interval" required>
                            <option value="5m" {% if form_values.interval == '5m' %}selected{% endif %}>5 Minute (5m)</option>
                            <option value="15m" {% if form_values.interval == '15m' %}selected{% endif %}>15 Minute (15m)</option>
                            <option value="30m" {% if form_values.interval == '30m' %}selected{% endif %}>30 Minute (30m)</option>
                            <option value="1h" {% if form_values.interval == '1h' %}selected{% endif %}>Hourly (1h)</option>
                            <option value="1d" {% if form_values.interval == '1d' %}selected{% endif %}>Daily (1d)</option>
                            <option value="5d" {% if form_values.interval == '5d' %}selected{% endif %}>5 Days (5d)</option>
                            <option value="1wk" {% if not form_values.interval or form_values.interval == '1wk' %}selected{% endif %}>Weekly (1wk)</option>
                            <option value="1mo" {% if form_values.interval == '1mo' %}selected{% endif %}>Monthly (1mo)</option>
                            <option value="3mo" {% if form_values.interval == '3mo' %}selected{% endif %}>3 Months (3mo)</option>
                        </select>
                    </div>
                </div> <div class="backtest-group">
                    <h4>Backtest Simulation (Optional)</h4>
                    <div class="backtest-enable-toggle">
                        <label class="form-toggle">
                            <label class="toggle-label" for="run_backtest">Enable Backtest Mode</label>
                            <span class="toggle-switch">
                                <input class="form-check-input" type="checkbox" value="true" id="run_backtest" name="run_backtest" {{ 'checked' if form_values.run_backtest == 'true' }}>
                                <span class="toggle-slider"></span>
                            </span>
                        </label>
                    </div>
                    <div class="backtest-dates">
                        <div class="input-group">
                            <label for="analysis_date">Analysis Date (Past End Date):</label>
                            <input type="date" class="form-control" id="analysis_date" name="analysis_date" value="{{ form_values.analysis_date or default_analysis_date }}">
                            <small>Run analysis *as if* this was the end date.</small>
                        </div>
                        <div class="input-group">
                            <label for="check_date">Check Date (Future End Date):</label>
                            <input type="date" class="form-control" id="check_date" name="check_date" value="{{ form_values.check_date or default_check_date }}">
                            <small>Show actual data up to this date.</small>
                        </div>
                    </div>
                </div> <div class="risk-group">
                     <h4>Risk & Position Size (Optional)</h4>
                     <div class="risk-inputs-row">
                          <div class="input-group">
                              <label for="risk_percent">Risk per Trade (% of Account):</label>
                              <input type="number" id="risk_percent" name="risk_percent" value="{{ form_values.risk_percent | default('1.0', true) }}" step="0.1" min="0.1" max="100" required>
                              <small>e.g., 1.0 = risk 1%</small>
                          </div>
                          <div class="input-group">
                              <label for="demo_account_size">Demo Account Size:</label>
                              <input type="number" id="demo_account_size" name="demo_account_size" value="{{ form_values.demo_account_size | default('10000', true) }}" step="100" min="100" required>
                              <small>e.g., 10000 (no currency symbol)</small>
                          </div>
                     </div>
                </div> <div class="submit-group">
                    <label class="form-toggle">
                       <label class="toggle-label" for="show_trade_on_plot">Show Trade Levels on Plot (if trade found)</label>
                        <span class="toggle-switch">
                            <input class="form-check-input" type="checkbox" value="true" id="show_trade_on_plot" name="show_trade_on_plot" {{ 'checked' if form_values.show_trade_on_plot == 'true' }}>
                           <span class="toggle-slider"></span>
                        </span>
                    </label>
                   <input type="submit" value="Run Analysis / Backtest">
               </div> </div> </form>

        {% if error %}
            <p class="error">{{ error }}</p>
        {% endif %}

        {% if multi_stock_results %}
            <h2>Multi-Stock Analysis Results</h2>
            <div class="filter-controls">
                <div class="table-controls">
                    <button type="button" id="toggle-table-btn" class="toggle-table-btn">
                        <span class="icon">▼</span>
                        <span class="btn-text">Hide Table</span>
                    </button>
                    <div class="stocks-count">
                        <span id="visible-stocks-count">Loading...</span>
                    </div>
                </div>
                <label class="form-toggle">
                    <label class="toggle-label" for="hide-no-entry">Hide Stocks Without Entry</label>
                    <span class="toggle-switch">
                        <input type="checkbox" id="hide-no-entry" checked>
                        <span class="toggle-slider"></span>
                    </span>
                </label>
            </div>
            <div class="multi-stock-results">
                <table class="stock-results-table">
                    <thead>
                        <tr>
                            <th class="sortable sort-asc" data-sort="ticker">Ticker</th>
                            <th class="sortable" data-sort="wave">Wave</th>
                            <th class="sortable" data-sort="signal">Signal</th>
                            <th class="sortable" data-sort="entry">Entry Price</th>
                            <th class="sortable" data-sort="sl">Stop Loss</th>
                            <th class="sortable" data-sort="tp1">TP1</th>
                            <th class="sortable" data-sort="rrr">R:R</th>
                            <th class="sortable" data-sort="score">Score</th>
                            <th class="sortable" data-sort="confidence">Confidence</th>
                            <th class="sortable" data-sort="status">Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in multi_stock_results %}
                        <tr class="{% if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' %}trade-found{% else %}no-trade{% endif %}"
                            data-has-entry="{% if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' %}true{% else %}false{% endif %}"
                            data-ticker="{{ result.ticker }}"
                            data-wave="{{ result.wave_info.current_wave if result.wave_info else 'N/A' }}"
                            data-signal="{{ result.trade_recommendation_data.signal if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' else 'N/A' }}"
                            data-entry="{{ result.trade_recommendation_data.entry_price if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' else '' }}"
                            data-sl="{{ result.trade_recommendation_data.stop_loss_price if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' else '' }}"
                            data-tp1="{{ result.trade_recommendation_data.tp1_price if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' else '' }}"
                            data-rrr="{{ result.trade_recommendation_data.tp1_rrr if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' and result.trade_recommendation_data.tp1_rrr is not none else '' }}"
                            data-score="{{ result.wave_info.score if result.wave_info else '' }}"
                            data-confidence="{{ result.trade_recommendation_data.confidence_score if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' else '' }}"
                            data-status="{{ result.trade_recommendation_data.status if result.trade_recommendation_data else result.error }}"
                            data-correction="{{ result.wave_info.correction if result.wave_info else False }}"
                            data-correction-target="{{ result.wave_info.correction_target if result.wave_info else 'N/A' }}"
                            data-impulse="{{ result.wave_info.impulse_identified if result.wave_info else False }}">
                            <td><strong>{{ result.ticker }}</strong></td>
                            <td class="wave-cell">
                                <span class="wave-label">{{ result.wave_info.current_wave if result.wave_info else 'N/A' }}</span>
                                {% if result.wave_info and result.wave_info.correction %}<span class="correction-badge" title="Possible correction forming, target: {{ result.wave_info.correction_target }}">ABC</span>{% endif %}
                                {% if result.wave_info and result.wave_info.impulse_identified %}<span class="impulse-badge" title="Complete impulse identified">✓</span>{% endif %}
                            </td>
                            <td>{{ result.trade_recommendation_data.signal if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' else 'N/A' }}</td>
                            <td>{{ '%.2f'|format(result.trade_recommendation_data.entry_price) if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' else 'N/A' }}</td>
                            <td>{{ '%.2f'|format(result.trade_recommendation_data.stop_loss_price) if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' else 'N/A' }}</td>
                            <td>{{ '%.2f'|format(result.trade_recommendation_data.tp1_price) if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' else 'N/A' }}</td>
                            <td>{{ '%.2f'|format(result.trade_recommendation_data.tp1_rrr) if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' and result.trade_recommendation_data.tp1_rrr is not none else 'N/A' }}</td>
                            <td>{{ result.wave_info.score if result.wave_info else 'N/A' }}</td>
                            <td>{{ result.trade_recommendation_data.confidence_score if result.trade_recommendation_data and result.trade_recommendation_data.status == 'Trade Found' else 'N/A' }}</td>
                            <td>{{ result.trade_recommendation_data.status if result.trade_recommendation_data else result.error }}</td>
                            <td>
                                <form method="POST" class="show-plot-form">
                                    <input type="hidden" name="analysis_mode" value="single"><input type="hidden" name="ticker" value="{{ result.ticker }}"><input type="hidden" name="start_date" value="{{ form_values.start_date }}"><input type="hidden" name="end_date" value="{{ form_values.end_date }}"><input type="hidden" name="interval" value="{{ form_values.interval }}"><input type="hidden" name="risk_percent" value="{{ form_values.risk_percent }}"><input type="hidden" name="demo_account_size" value="{{ form_values.demo_account_size }}"><input type="hidden" name="show_trade_on_plot" value="true"><input type="hidden" name="from_multi_stock" value="true"><input type="hidden" name="original_stock_list" value="{{ form_values.stock_list }}"><button type="submit" class="show-plot-btn">Plot</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}

        {% if plot_html %}
            <h2>
                {% if form_values.run_backtest == 'true' %}
                    Backtest Result for {{ form_values.ticker }} (Analyzed as of {{ form_values.analysis_date }}, Checked to {{ form_values.check_date }}, {{ form_values.interval }})
                {% else %}
                     {% if form_values.analysis_mode == 'single' %}
                        Analysis Result for {{ form_values.ticker }}
                     {% else %}
                         Detailed Plot for {{ form_values.ticker }} (from Multi-Stock Analysis)
                     {% endif %}
                     ({{ form_values.start_date }} to {{ form_values.end_date | default('Today', true) }}, {{ form_values.interval }})
                {% endif %}
            </h2>
            <div class="plot-container">{{ plot_html | safe }}</div>
        {% elif request.method == 'POST' and not error and not multi_stock_results %}
             <p style="text-align:center; color: #999; margin: 40px 0;">No plot generated. Check parameters or console logs.</p>
        {% endif %}

        {% if trade_recommendation_data %}
            <div class="trade-recommendation-section">
                <h3>Trade Recommendation Idea (Based on Analysis)</h3>
                {% if trade_recommendation_data.status == 'Trade Found' %}
                    <div class="trade-grid">
                        <div class="trade-item signal-{{ trade_recommendation_data.signal | lower }}"><label>Signal:</label><span class="value">{{ trade_recommendation_data.signal }}</span></div>
                        <div class="trade-item confidence-score"><label>Confidence Score:</label><span class="value">{{ trade_recommendation_data.confidence_score }} / 100</span></div>
                        <div class="trade-item"><label>Reason:</label><span class="value" style="font-size: 0.9em; color: var(--text-secondary); font-weight: normal; line-height: 1.4;">{{ trade_recommendation_data.reason }}</span></div>
                        <div class="trade-item"><label>Entry Price:</label><span class="value">{{ "%.4f"|format(trade_recommendation_data.entry_price) }} {{ trade_recommendation_data.currency }}</span></div>
                        <div class="trade-item signal-{{ 'long' if trade_recommendation_data.signal == 'Short' else 'short' }}"><label>Stop Loss Price:</label><span class="value">{{ "%.4f"|format(trade_recommendation_data.stop_loss_price) }}</span><small>({{ "%.2f"|format(trade_recommendation_data.sl_distance_pct) }}% / {{ "%.4f"|format(trade_recommendation_data.sl_distance_pips) }} points)</small></div>
                        <div class="trade-item risk-reward"><label>Risk Amount:</label><span class="value">{{ "%.2f"|format(trade_recommendation_data.risk_amount) }} {{ trade_recommendation_data.currency }}</span><small>({{ trade_recommendation_data.risk_percent }}% of {{ "{:,.0f}".format(trade_recommendation_data.account_size) }})</small></div>
                        <div class="trade-item signal-{{ trade_recommendation_data.signal | lower }}"><label>Take Profit 1:</label>{% if trade_recommendation_data.tp1_price %}<span class="value">{{ "%.4f"|format(trade_recommendation_data.tp1_price) }}</span>{% else %}<span class="value" style="color:var(--text-muted);">N/A</span>{% endif %}</div>
                        <div class="trade-item risk-reward"><label>TP1 Risk/Reward:</label>{% if trade_recommendation_data.tp1_rrr %}<span class="value">{{ "%.2f"|format(trade_recommendation_data.tp1_rrr) }}:1</span>{% else %}<span class="value" style="color:var(--text-muted);">N/A</span>{% endif %}</div>
                        <div class="trade-item"><label>Position Size:</label><span class="value">{{ "%.4f"|format(trade_recommendation_data.position_size_units) }} Units/Shares</span><small>(Check contract specs!)</small></div>
                        <div class="trade-item signal-{{ trade_recommendation_data.signal | lower }}"><label>Take Profit 2:</label>{% if trade_recommendation_data.tp2_price %}<span class="value">{{ "%.4f"|format(trade_recommendation_data.tp2_price) }}</span>{% else %}<span class="value" style="color:var(--text-muted);">N/A</span>{% endif %}</div>
                        <div class="trade-item risk-reward"><label>TP2 Risk/Reward:</label>{% if trade_recommendation_data.tp2_rrr %}<span class="value">{{ "%.2f"|format(trade_recommendation_data.tp2_rrr) }}:1</span>{% else %}<span class="value" style="color:var(--text-muted);">N/A</span>{% endif %}</div>
                        <div class="trade-item"></div>
                    </div>
                    <p class="trade-notes">{{ trade_recommendation_data.notes }}</p>
                {% elif trade_recommendation_data.status == 'No Trade' %}
                    <p class="no-trade">{{ trade_recommendation_data.reason | default('No actionable trade setup identified based on the current analysis.', true) }}</p>
                {% else %}
                    <p class="error" style="text-align:left;">Error generating recommendation: {{ trade_recommendation_data.reason | default('An unspecified error occurred.', true) }}</p>
                {% endif %}
            </div>
        {% elif request.method == 'POST' and not error and not multi_stock_results %}
              {% if analysis_summary_data and not analysis_summary_data.get('error') %}
                <div class="trade-recommendation-section"><h3>Trade Recommendation Idea</h3><p class="no-trade">Could not generate trade recommendation (Check logs for details).</p></div>
              {% endif %}
        {% endif %}

        {% if analysis_summary_data and not analysis_summary_data.get('error') %}
            <h2>Analysis Summary {% if form_values.run_backtest == 'true' %}(Performed as of {{ form_values.analysis_date }}){% endif %}</h2>
              {% if analysis_summary_data.warning %}<p class="error" style="background-color: rgba(229, 192, 123, 0.1); border-color: #e5c07b; color: #e5c07b;">Warning: {{ analysis_summary_data.warning }}</p>{% endif %}
            {% if analysis_summary_data.found_impulse %}
                <div class="summary-section">
                    <h3>Overall Status</h3>
                    <ul class="summary-list">
                        <li>Identified Impulse Sequence? <span class="value-true">True</span></li><li>Sequence Found: <span class="value">0 - {{ analysis_summary_data.details.last_label }}</span></li><li>Direction: <span class="value">{{ "Upward" if analysis_summary_data.details.is_upward else "Downward" }}</span></li><li>Quality Score: <span class="value">{{ "%.1f"|format(analysis_summary_data.details.score) }}</span> (Higher generally better)</li><li>Number of Points: <span class="value">{{ analysis_summary_data.details.length }}</span> (0 to {{ analysis_summary_data.details.last_label }})</li><li>Last Impulse Point Date: <span class="value">{% if analysis_summary_data.details.last_point is not none and analysis_summary_data.details.last_point.name is not none %}{{ analysis_summary_data.details.last_point.name.strftime('%Y-%m-%d') }}{% else %}N/A{% endif %}</span></li><li>Last Point Overall Date: <span class="value">{% if analysis_summary_data.last_point_overall is not none and analysis_summary_data.last_point_overall.name is not none %}{{ analysis_summary_data.last_point_overall.name.strftime('%Y-%m-%d') }}{% else %}N/A{% endif %}</span> (Label: {{ analysis_summary_data.last_label }})</li>
                    </ul>
                </div>
                {% if analysis_summary_data.details %}
                    <div class="summary-grid">
                        <div class="summary-section">
                            <h3>Rule Compliance (Mandatory)</h3>
                            {% if analysis_summary_data.details.rules_passed %}<ul class="summary-list checks">{% for rule, passed in analysis_summary_data.details.rules_passed.items() %}<li>{{ rule.replace('_', ' ').title() }}: <span class="value-{{ passed | lower }}">{{ "Passed" if passed else "FAILED" }}</span></li>{% endfor %}</ul>{% else %}<p>No rule compliance data available.</p>{% endif %}
                        </div>
                        <div class="summary-section">
                            <h3>Guideline Check (Common Patterns)</h3>
                             {% if analysis_summary_data.details.guidelines %}<ul class="summary-list checks">{% for guideline, met in analysis_summary_data.details.guidelines.items() %}{% if not guideline.startswith('Vol_') %}<li>{{ guideline.replace('_', ' ').title() }}: <span class="value-{{ met | lower }}">{{ "Met" if met else "Not Met" }}</span></li>{% endif %}{% endfor %}</ul>{% else %}<p>No guideline data available.</p>{% endif %}
                        </div>
                         <div class="summary-section">
                            <h3>Fibonacci Ratios (Wave Relationships)</h3>
                            {% if analysis_summary_data.details.fib_ratios %}<ul class="summary-list fibs">{% for name, data in analysis_summary_data.details.fib_ratios.items() %}{% if data is iterable and data|length == 2 and data[0] is not none and data[0] != 'NaN' and data[0] is number %}<li>{{ name.replace('_', ' ').title() }}: <span class="value">{{ data[1] }}</span> <span>(Actual: {{ "%.3f"|format(data[0]) }})</span></li>{% else %}<li>{{ name.replace('_', ' ').title() }}: <span class="value" style="color:var(--text-muted)">N/A</span> <span>(Actual: {{ data[0] | default('N/A') }})</span></li>{% endif %}{% endfor %}</ul>{% else %}<p>No Fibonacci ratio data available.</p>{% endif %}
                        </div>
                         <div class="summary-section">
                            <h3>Volume Analysis (Basic Guidelines)</h3>
                            {% if analysis_summary_data.details.guidelines or analysis_summary_data.details.volume_details %}
                                <ul class="summary-list checks">{% set vol_guidelines_exist = false %}{% if analysis_summary_data.details.guidelines %}{% for guideline, met in analysis_summary_data.details.guidelines.items() %}{% if guideline.startswith('Vol_') %}{% set vol_guidelines_exist = true %}<li>{{ guideline.replace('Vol_', '').replace('_', ' ').title() }}: <span class="value-{{ met | lower }}">{{ "Met" if met else "Not Met" }}</span></li>{% endif %}{% endfor %}{% endif %}{% if not vol_guidelines_exist %}<li><span class="value-false" style="font-weight:normal; text-align: left; flex-shrink: 1;">No volume guideline data available or checks skipped.</span></li>{% endif %}</ul>
                                 {% if analysis_summary_data.details.volume_details %}<details class="volume-details"><summary>Avg. Volume per Wave</summary><ul class="summary-list raw-vol">{% for name, vol in analysis_summary_data.details.volume_details.items() %}{% set vol_display = "{:,.0f}".format(vol) if vol is number else vol %}<li>{{ name.replace('AvgVol_', 'Wave ') }}: <span class="value">{{ vol_display }}</span></li>{% endfor %}</ul></details>{% endif %}
                            {% else %}<p>No volume data available.</p>{% endif %}
                        </div>
                        {% if analysis_summary_data.details.correction_guess %}
                        <div class="summary-section correction-guess">
                            <h3>Correction Guess (Post-Impulse)</h3><p>A potential A-B-C correction pattern might be forming after Wave 5.</p>
                             <ul class="summary-list"><li>Est. A: <span class="value">{% if analysis_summary_data.details.correction_guess.A is not none and analysis_summary_data.details.correction_guess.A.name is not none %}{{ analysis_summary_data.details.correction_guess.A.name.strftime('%Y-%m-%d') }}{% else %}N/A{% endif %}</span></li><li>Est. B: <span class="value">{% if analysis_summary_data.details.correction_guess.B is not none and analysis_summary_data.details.correction_guess.B.name is not none %}{{ analysis_summary_data.details.correction_guess.B.name.strftime('%Y-%m-%d') }}{% else %}N/A{% endif %}</span></li><li>Est. C: <span class="value">{% if analysis_summary_data.details.correction_guess.C is not none and analysis_summary_data.details.correction_guess.C.name is not none %}{{ analysis_summary_data.details.correction_guess.C.name.strftime('%Y-%m-%d') }}{% else %}N/A{% endif %}</span></li></ul>
                        </div>
                         {% endif %}
                    </div>
                {% endif %}
            {% else %}
                 <div class="summary-section"><h3>Overall Status</h3><ul class="summary-list"><li>Identified Impulse Sequence? <span class="value-false">False</span></li><li><span class="value-false" style="font-weight:normal; text-align: left; flex-shrink: 1;">No standard Elliott Wave impulse sequence (0-5 waves) identified based on current rules/scoring. Check P-labels on chart for potential pivots.</span></li><li>Last Point Overall Date: <span class="value">{% if analysis_summary_data.last_point_overall is not none and analysis_summary_data.last_point_overall.name is not none %}{{ analysis_summary_data.last_point_overall.name.strftime('%Y-%m-%d') }}{% else %}N/A{% endif %}</span> (Label: {{ analysis_summary_data.last_label }})</li></ul></div>
            {% endif %}
            {% if analysis_summary_pretty %}
                <details class="raw-data-details"><summary>Raw Analysis Data (JSON)</summary><pre>{{ analysis_summary_pretty }}</pre></details>
            {% endif %}
        {% elif request.method == 'POST' and not error and not multi_stock_results %}
             <p style="text-align:center; color: #999; margin: 40px 0;">Analysis request processed, but no summary data available (check parameters or console logs).</p>
        {% endif %}

        <div class="disclaimer">
            <strong>*** DEMO / EDUCATIONAL USE ONLY - EXTREME WARNING ***</strong><br>
            This tool attempts conceptual Elliott Wave analysis. Results, paths, projections, and any generated trade ideas are highly speculative, potentially inaccurate, and unreliable. <strong>DO NOT RISK ANY REAL MONEY BASED ON THIS OUTPUT.</strong> Trading involves substantial risk of loss. Always conduct your own thorough research and consult with a qualified financial advisor before making any investment decisions.
        </div>

        <footer>
            <p>Made by <a href="https://github.com/ESJavadex" target="_blank" rel="noopener noreferrer">Esjavadex</a></p>
        </footer>

    </div> <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Elements ---
            const hideNoEntryCheckbox = document.getElementById('hide-no-entry');
            const stockTableBody = document.querySelector('.stock-results-table tbody');
            const stockRows = stockTableBody ? Array.from(stockTableBody.querySelectorAll('tr[data-has-entry]')) : [];
            const sortableHeaders = document.querySelectorAll('th.sortable');
            const presetButtons = document.querySelectorAll('.preset-btn');
            const stockListInput = document.getElementById('stock_list');
            const analysisModeSelect = document.getElementById('analysis_mode');
            const toggleTableBtn = document.getElementById('toggle-table-btn');
            const multiStockResultsDiv = document.querySelector('.multi-stock-results');
            const visibleCountSpan = document.getElementById('visible-stocks-count');
            const singleTickerGroup = document.getElementById('single-ticker-group');
            const multiStockInputsGroup = document.getElementById('multi-stock-inputs');
            const singleTickerInput = document.getElementById('ticker');

            // --- State Variables ---
            let currentSortColumn = 'ticker';
            let currentSortDirection = 'asc';
            let tableCollapsed = false;

            // --- Initial Setup ---
            toggleAnalysisModeInputs();
            if (analysisModeSelect) {
                 analysisModeSelect.addEventListener('change', toggleAnalysisModeInputs);
            }

            if (stockTableBody && stockRows.length > 0) {
                applyFilter();
                updateSortClasses(currentSortColumn, currentSortDirection);
                sortTable(currentSortColumn, currentSortDirection);
                updateVisibleCount();

                 if (hideNoEntryCheckbox) {
                    hideNoEntryCheckbox.addEventListener('change', () => {
                         applyFilter();
                         updateVisibleCount();
                     });
                 }

                if (toggleTableBtn && multiStockResultsDiv) {
                     tableCollapsed = multiStockResultsDiv.classList.contains('collapsed');
                     updateToggleButton(tableCollapsed);
                    toggleTableBtn.addEventListener('click', () => {
                        tableCollapsed = !tableCollapsed;
                        multiStockResultsDiv.classList.toggle('collapsed', tableCollapsed);
                        updateToggleButton(tableCollapsed);
                    });
                }

                sortableHeaders.forEach(header => {
                    header.addEventListener('click', () => {
                        const column = header.getAttribute('data-sort');
                        if (column === currentSortColumn) {
                            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSortColumn = column;
                            currentSortDirection = 'asc';
                        }
                        updateSortClasses(currentSortColumn, currentSortDirection);
                        sortTable(currentSortColumn, currentSortDirection);
                    });
                });
             } else if (multiStockResultsDiv) {
                 const filterControls = document.querySelector('.filter-controls');
                 if (filterControls) {
                     if(visibleCountSpan) visibleCountSpan.textContent = "No stocks to display.";
                 }
             }

            presetButtons.forEach(button => {
                button.addEventListener('click', () => {
                     const stocks = button.getAttribute('data-stocks');
                     if (stockListInput && stocks !== null) {
                         stockListInput.value = stocks.trim().replace(/\s+/g, '');
                         stockListInput.focus();
                         stockListInput.blur();
                     }
                     if (analysisModeSelect && stocks !== "" && stocks !== null) {
                         analysisModeSelect.value = 'multi';
                         analysisModeSelect.dispatchEvent(new Event('change'));
                     }
                });
            });

            // --- Functions ---
            function toggleAnalysisModeInputs() {
                 if (!analysisModeSelect || !singleTickerGroup || !multiStockInputsGroup) return;
                const selectedMode = analysisModeSelect.value;
                if (selectedMode === 'multi') {
                    singleTickerGroup.style.display = 'none';
                    multiStockInputsGroup.style.display = 'flex'; // Use flex for the container
                    if(singleTickerInput) singleTickerInput.removeAttribute('required');
                    if(stockListInput) stockListInput.setAttribute('required', 'required');
                } else {
                    singleTickerGroup.style.display = 'flex'; // Use flex for the container
                    multiStockInputsGroup.style.display = 'none';
                    if(singleTickerInput) singleTickerInput.setAttribute('required', 'required');
                    if(stockListInput) stockListInput.removeAttribute('required');
                }
             }

            function updateToggleButton(isCollapsed) {
                 if (!toggleTableBtn) return;
                 toggleTableBtn.classList.toggle('collapsed', isCollapsed);
                 toggleTableBtn.querySelector('.btn-text').textContent = isCollapsed ? 'Show Table' : 'Hide Table';
                 const icon = toggleTableBtn.querySelector('.icon');
                 if (icon) icon.textContent = isCollapsed ? '►' : '▼';
             }

            function updateSortClasses(column, direction) {
                sortableHeaders.forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                    if (h.getAttribute('data-sort') === column) {
                        h.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                });
            }

            function applyFilter() {
                 if (!hideNoEntryCheckbox) return;
                const hideNoEntry = hideNoEntryCheckbox.checked;
                stockRows.forEach(row => {
                    const hasEntry = row.getAttribute('data-has-entry') === 'true';
                    row.classList.toggle('hidden', !hasEntry && hideNoEntry);
                });
            }

            function sortTable(column, direction) {
                if (!stockTableBody) return;
                const numericColumns = ['entry', 'sl', 'tp1', 'rrr', 'score', 'confidence'];
                const isNumeric = numericColumns.includes(column);
                stockRows.sort((a, b) => {
                    let aValue = a.getAttribute(`data-${column}`) || '';
                    let bValue = b.getAttribute(`data-${column}`) || '';
                    let aIsNA = aValue === '' || aValue.toLowerCase() === 'n/a';
                    let bIsNA = bValue === '' || bValue.toLowerCase() === 'n/a';
                    if (isNumeric) {
                         const valA = !aIsNA ? parseFloat(aValue) : (direction === 'asc' ? Infinity : -Infinity);
                         const valB = !bIsNA ? parseFloat(bValue) : (direction === 'asc' ? Infinity : -Infinity);
                         if (isNaN(valA) && isNaN(valB)) return 0;
                         if (isNaN(valA)) return 1;
                         if (isNaN(valB)) return -1;
                         aValue = valA;
                         bValue = valB;
                    } else {
                         aValue = aValue.toLowerCase();
                         bValue = bValue.toLowerCase();
                         aIsNA = aValue === '' || aValue === 'n/a';
                         bIsNA = bValue === '' || bValue === 'n/a';
                         if (aIsNA && bIsNA) return 0;
                         if (aIsNA) return 1;
                         if (bIsNA) return -1;
                    }
                    if (aValue < bValue) return direction === 'asc' ? -1 : 1;
                    if (aValue > bValue) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
                stockRows.forEach(row => stockTableBody.appendChild(row));
            }

            function updateVisibleCount() {
                 if (!visibleCountSpan) return;
                const visibleRows = stockRows.filter(row => !row.classList.contains('hidden'));
                const totalRows = stockRows.length;
                 if (totalRows === 0) {
                    visibleCountSpan.textContent = "No stocks analysed.";
                 } else {
                     visibleCountSpan.textContent = `Showing ${visibleRows.length} of ${totalRows} stocks`;
                 }
            }
        });
    </script>

</body>
</html>